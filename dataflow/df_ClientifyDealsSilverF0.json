{
	"name": "df_ClientifyDealsSilverF0",
	"properties": {
		"folder": {
			"name": "SilverF0"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_adsl_json",
						"type": "DatasetReference"
					},
					"name": "sourceClientifyBronze"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "ls_adsl",
						"type": "LinkedServiceReference"
					},
					"name": "sinkClientifySilver"
				}
			],
			"transformations": [
				{
					"name": "flattenResult"
				},
				{
					"name": "select1",
					"description": "quitado custumfields y tags porque array"
				},
				{
					"name": "selectCustomFields"
				},
				{
					"name": "flattenCustomFields"
				},
				{
					"name": "pivotCustomFields"
				},
				{
					"name": "join1"
				},
				{
					"name": "selectFinal",
					"description": "quitado id pivot"
				},
				{
					"name": "derivedColumnCustomFields"
				},
				{
					"name": "filterCustomFields"
				},
				{
					"name": "MapDriftedCustomFields",
					"description": "Crea una asignación explícita para cada columna de desfase."
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "alterRow1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          count as short,",
				"          next as string,",
				"          previous as string,",
				"          results as (actual_closed_date as date, amount as double, amount_user as string, company as string, contact as string, contact_email as string, contact_medium as string, contact_name as string, contact_phone as long, contact_source as string, created as string, currency as string, custom_fields as (field as string, id as integer, value as string)[], expected_closed_date as date, id as integer, modified as string, name as string, owner_name as string, pipeline as string, pipeline_desc as string, pipeline_stage as string, pipeline_stage_desc as string, probability as short, probability_desc as string, status as short, status_desc as string, tags as string[], url as string)[]",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     rowUrlColumn: 'filepath',",
				"     documentForm: 'documentPerLine') ~> sourceClientifyBronze",
				"sourceClientifyBronze foldDown(unroll(results),",
				"     mapColumn(",
				"          actual_closed_date = results.actual_closed_date,",
				"          amount = results.amount,",
				"          amount_user = results.amount_user,",
				"          company = results.company,",
				"          contact = results.contact,",
				"          contact_email = results.contact_email,",
				"          contact_medium = results.contact_medium,",
				"          contact_name = results.contact_name,",
				"          contact_phone = results.contact_phone,",
				"          contact_source = results.contact_source,",
				"          created = results.created,",
				"          currency = results.currency,",
				"          custom_fields = results.custom_fields,",
				"          expected_closed_date = results.expected_closed_date,",
				"          id = results.id,",
				"          modified = results.modified,",
				"          name = results.name,",
				"          owner_name = results.owner_name,",
				"          pipeline = results.pipeline,",
				"          pipeline_desc = results.pipeline_desc,",
				"          pipeline_stage = results.pipeline_stage,",
				"          pipeline_stage_desc = results.pipeline_stage_desc,",
				"          probability = results.probability,",
				"          probability_desc = results.probability_desc,",
				"          status = results.status,",
				"          status_desc = results.status_desc,",
				"          tags = results.tags,",
				"          url = results.url,",
				"          filepath",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flattenResult",
				"flattenResult select(mapColumn(",
				"          actual_closed_date,",
				"          amount,",
				"          amount_user,",
				"          company,",
				"          contact,",
				"          contact_email,",
				"          contact_medium,",
				"          contact_name,",
				"          contact_phone,",
				"          contact_source,",
				"          created,",
				"          currency,",
				"          expected_closed_date,",
				"          id,",
				"          modified,",
				"          name,",
				"          owner_name,",
				"          pipeline,",
				"          pipeline_desc,",
				"          pipeline_stage,",
				"          pipeline_stage_desc,",
				"          probability,",
				"          probability_desc,",
				"          status,",
				"          status_desc,",
				"          url,",
				"          filepath",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"flattenResult select(mapColumn(",
				"          custom_fields,",
				"          id",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectCustomFields",
				"selectCustomFields foldDown(unroll(custom_fields),",
				"     mapColumn(",
				"          custom_fields_field = custom_fields.field,",
				"          custom_fields_id = custom_fields.id,",
				"          custom_fields_value = custom_fields.value,",
				"          id",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flattenCustomFields",
				"filterCustomFields pivot(groupBy(id),",
				"     pivotBy(custom_fields_field),",
				"     custom_fields_ = max(custom_fields_value),",
				"     columnNaming: '$N$V',",
				"     lateral: true,",
				"     partitionBy('hash', 1)) ~> pivotCustomFields",
				"select1, MapDriftedCustomFields join(select1@id == pivotCustomFields@id,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     partitionBy('hash', 1),",
				"     broadcast: 'auto')~> join1",
				"derivedColumn1 select(mapColumn(",
				"          actual_closed_date,",
				"          amount,",
				"          amount_user,",
				"          company,",
				"          contact,",
				"          contact_email,",
				"          contact_medium,",
				"          contact_name,",
				"          contact_phone,",
				"          contact_source,",
				"          created,",
				"          currency,",
				"          expected_closed_date,",
				"          id,",
				"          modified,",
				"          name,",
				"          owner_name,",
				"          pipeline,",
				"          pipeline_desc,",
				"          pipeline_stage,",
				"          pipeline_stage_desc,",
				"          probability,",
				"          probability_desc,",
				"          status,",
				"          status_desc,",
				"          url,",
				"          filepath,",
				"          custom_fields_ByRatings_Rating,",
				"          custom_fields_ByRatings_Score,",
				"          custom_fields_Estudio_Old,",
				"          custom_fields_ID,",
				"          custom_fields_Modalidad_Old,",
				"          custom_fields_Sede_Old,",
				"          custom_fields_anio_academico,",
				"          custom_fields_campaign_id,",
				"          custom_fields_centro,",
				"          custom_fields_ciudad,",
				"          custom_fields_cp,",
				"          custom_fields_curso_anio,",
				"          custom_fields_descuento,",
				"          custom_fields_descuento_matricula,",
				"          custom_fields_estudio,",
				"          custom_fields_fecha_inscripcion,",
				"          custom_fields_gclid,",
				"          custom_fields_gdpr,",
				"          custom_fields_google_id,",
				"          custom_fields_linea_negocio,",
				"          custom_fields_matricula,",
				"          custom_fields_mensualidad,",
				"          custom_fields_modalidad,",
				"          custom_fields_pais,",
				"          custom_fields_ref,",
				"          custom_fields_sede,",
				"          custom_fields_tipo_conversion,",
				"          custom_fields_turno,",
				"          custom_fields_ua,",
				"          custom_fields_url,",
				"          custom_fields_utm_ad_id,",
				"          custom_fields_utm_adset_id,",
				"          custom_fields_utm_campaign,",
				"          custom_fields_utm_campaign_id,",
				"          custom_fields_utm_campaign_name,",
				"          custom_fields_utm_channel,",
				"          custom_fields_utm_device,",
				"          custom_fields_utm_estrategia,",
				"          custom_fields_utm_medium,",
				"          custom_fields_utm_network,",
				"          custom_fields_utm_placement,",
				"          custom_fields_utm_site_source_name,",
				"          custom_fields_utm_source,",
				"          custom_fields_utm_term,",
				"          custom_fields_utm_type,",
				"          processdate,",
				"          sourcesystem,",
				"          created_tzh,",
				"          modified_tzh",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectFinal",
				"flattenCustomFields derive(custom_fields_field = replace(replace(custom_fields_field,' ','_'),'-','_'),",
				"     partitionBy('hash', 1)) ~> derivedColumnCustomFields",
				"derivedColumnCustomFields filter(custom_fields_field!='Año_Académico',",
				"     partitionBy('hash', 1)) ~> filterCustomFields",
				"pivotCustomFields derive(custom_fields_ByRatings_Rating = toString(byName('custom_fields_ByRatings_Rating')),",
				"          custom_fields_ByRatings_Score = toString(byName('custom_fields_ByRatings_Score')),",
				"          custom_fields_Estudio_Old = toString(byName('custom_fields_Estudio_Old')),",
				"          custom_fields_ID = toString(byName('custom_fields_ID')),",
				"          custom_fields_Modalidad_Old = toString(byName('custom_fields_Modalidad_Old')),",
				"          custom_fields_Sede_Old = toString(byName('custom_fields_Sede_Old')),",
				"          custom_fields_anio_academico = toString(byName('custom_fields_anio_academico')),",
				"          custom_fields_campaign_id = toString(byName('custom_fields_campaign_id')),",
				"          custom_fields_centro = toString(byName('custom_fields_centro')),",
				"          custom_fields_ciudad = toString(byName('custom_fields_ciudad')),",
				"          custom_fields_cp = toString(byName('custom_fields_cp')),",
				"          custom_fields_curso_anio = toString(byName('custom_fields_curso_anio')),",
				"          custom_fields_descuento = toString(byName('custom_fields_descuento')),",
				"          custom_fields_descuento_matricula = toString(byName('custom_fields_descuento_matricula')),",
				"          custom_fields_estudio = toString(byName('custom_fields_estudio')),",
				"          custom_fields_fecha_inscripcion = toString(byName('custom_fields_fecha_inscripcion')),",
				"          custom_fields_gclid = toString(byName('custom_fields_gclid')),",
				"          custom_fields_gdpr = toString(byName('custom_fields_gdpr')),",
				"          custom_fields_google_id = toString(byName('custom_fields_google_id')),",
				"          custom_fields_linea_negocio = toString(byName('custom_fields_linea_negocio')),",
				"          custom_fields_matricula = toString(byName('custom_fields_matricula')),",
				"          custom_fields_mensualidad = toString(byName('custom_fields_mensualidad')),",
				"          custom_fields_modalidad = toString(byName('custom_fields_modalidad')),",
				"          custom_fields_pais = toString(byName('custom_fields_pais')),",
				"          custom_fields_ref = toString(byName('custom_fields_ref')),",
				"          custom_fields_sede = toString(byName('custom_fields_sede')),",
				"          custom_fields_tipo_conversion = toString(byName('custom_fields_tipo_conversion')),",
				"          custom_fields_turno = toString(byName('custom_fields_turno')),",
				"          custom_fields_ua = toString(byName('custom_fields_ua')),",
				"          custom_fields_url = toString(byName('custom_fields_url')),",
				"          custom_fields_utm_ad_id = toString(byName('custom_fields_utm_ad_id')),",
				"          custom_fields_utm_adset_id = toString(byName('custom_fields_utm_adset_id')),",
				"          custom_fields_utm_campaign = toString(byName('custom_fields_utm_campaign')),",
				"          custom_fields_utm_campaign_id = toString(byName('custom_fields_utm_campaign_id')),",
				"          custom_fields_utm_campaign_name = toString(byName('custom_fields_utm_campaign_name')),",
				"          custom_fields_utm_channel = toString(byName('custom_fields_utm_channel')),",
				"          custom_fields_utm_device = toString(byName('custom_fields_utm_device')),",
				"          custom_fields_utm_estrategia = toString(byName('custom_fields_utm_estrategia')),",
				"          custom_fields_utm_medium = toString(byName('custom_fields_utm_medium')),",
				"          custom_fields_utm_network = toString(byName('custom_fields_utm_network')),",
				"          custom_fields_utm_placement = toString(byName('custom_fields_utm_placement')),",
				"          custom_fields_utm_site_source_name = toString(byName('custom_fields_utm_site_source_name')),",
				"          custom_fields_utm_source = toString(byName('custom_fields_utm_source')),",
				"          custom_fields_utm_term = toString(byName('custom_fields_utm_term')),",
				"          custom_fields_utm_type = toString(byName('custom_fields_utm_type')),",
				"     partitionBy('hash', 1)) ~> MapDriftedCustomFields",
				"join1 derive(processdate = currentUTC(),",
				"          sourcesystem = 'Clientify',",
				"          contact_phone = toString(contact_phone),",
				"          id = toString(select1@id),",
				"          probability = toInteger(probability),",
				"          status = toInteger(status),",
				"          created = toTimestamp(split(created,'+')[1],'yyyy-MM-dd\\'T\\'HH:mm:ss'),",
				"          created_tzh = split(created,'+')[2],",
				"          modified = toTimestamp(split(modified,'+')[1],'yyyy-MM-dd\\'T\\'HH:mm:ss'),",
				"          modified_tzh = split(modified,'+')[2],",
				"          custom_fields_fecha_inscripcion = toDate(custom_fields_fecha_inscripcion,'dd/MM/yyyy'),",
				"          custom_fields_descuento = toDouble(custom_fields_descuento),",
				"          custom_fields_descuento_matricula = toDouble(custom_fields_descuento_matricula),",
				"     partitionBy('hash', 1)) ~> derivedColumn1",
				"selectFinal alterRow(upsertIf(true()),",
				"     partitionBy('hash', 1)) ~> alterRow1",
				"alterRow1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'delta',",
				"     fileSystem: 'silver',",
				"     folderPath: 'lakehousef0/clientifydeals',",
				"     mergeSchema: false,",
				"     autoCompact: false,",
				"     optimizedWrite: false,",
				"     vacuum: 0,",
				"     deletable: false,",
				"     insertable: false,",
				"     updateable: false,",
				"     upsertable: true,",
				"     keys:['id'],",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> sinkClientifySilver"
			]
		}
	}
}